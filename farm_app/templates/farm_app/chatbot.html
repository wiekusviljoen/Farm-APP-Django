<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Chatbot Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px 10px 0 0;
            padding: 20px;
        }

        .card-header h3 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        #chatbox {
            background-color: #f8f9fa;
            border-radius: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .alert {
            border-radius: 8px;
            border: none;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 10px 30px;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }

        .form-control {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .container {
            max-width: 900px;
        }

        .nav-buttons {
            margin-top: 20px;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        .card-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="card">
                    <div class="card-header text-white">
                        <h3 class="mb-0">
                            <i class="fas fa-robot"></i> Farm Advisor AI
                            {% if farm %}
                            - {{ farm.name }}
                            {% endif %}
                        </h3>
                        <small>Get expert advice on farming and animal feeds</small>
                    </div>

                    <div class="card-body" id="chatbox"
                        style="height: 450px; overflow-y: auto; background-color: #f8f9fa;">
                        {% if chat_history %}
                        {% for message in chat_history %}
                        <!-- User message -->
                        <div class="mb-3">
                            <div class="alert alert-info" role="alert">
                                <strong>üë§ You:</strong> {{ message.user_message }}
                                <br>
                                <small class="text-muted">{{ message.created_at|date:"M d, Y H:i" }}</small>
                            </div>
                        </div>

                        <!-- AI response -->
                        <div class="mb-3">
                            <div class="alert alert-success" role="alert">
                                <strong><i class="fas fa-lightbulb"></i> Farm Advisor:</strong>
                                <p class="mb-0" style="margin-top: 10px; white-space: pre-wrap;">{{ message.ai_response
                                    }}</p>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="alert alert-secondary" role="alert">
                            <p><strong>üëã Welcome to your Farm Advisor!</strong></p>
                            <p>Ask me anything about:</p>
                            <ul style="margin-bottom: 0;">
                                <li>üåæ Cattle feeding and nutrition</li>
                                <li>üè• Disease prevention and animal health</li>
                                <li>üë∂ Breeding recommendations</li>
                                <li>üí∞ Feed cost optimization</li>
                                <li>üìä Farm management practices</li>
                                <li>‚ùì And much more!</li>
                            </ul>
                            <p style="margin-top: 10px;"><em>Start by typing your question below.</em></p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="card-footer">
                        <form id="chatForm" method="post"
                            action="{% if farm %}{% url 'farm_app:send_chat_message' farm.id %}{% else %}{% url 'farm_app:send_chat_message_global' %}{% endif %}">
                            {% csrf_token %}
                            <div class="form-group mb-3">
                                <label for="id_message"><strong>Your Question:</strong></label>
                                <textarea id="id_message" name="message" class="form-control" rows="3"
                                    placeholder="e.g., What should I feed my pregnant cows? How do I prevent cattle diseases?"
                                    required style="resize: vertical;"></textarea>
                                {% if form.message.errors %}
                                <div class="alert alert-danger mt-2">{{ form.message.errors }}</div>
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Send Message
                            </button>
                        </form>
                    </div>
                </div>

                <div class="nav-buttons">
                    {% if farm %}
                    <a href="{% url 'farm_app:farm_detail' farm.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Farm
                    </a>
                    {% else %}
                    <a href="{% url 'farm_app:farm_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Farms
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-scroll to bottom of chatbox
        function scrollToBottom() {
            const chatbox = document.getElementById('chatbox');
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Scroll on page load
        document.addEventListener('DOMContentLoaded', scrollToBottom);

        // Handle form submission with AJAX
        document.getElementById('chatForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const messageInput = document.getElementById('id_message');
            const message = messageInput.value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const formData = new FormData(this);
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Add user message to chatbox
                    const chatbox = document.getElementById('chatbox');
                    const userDiv = document.createElement('div');
                    userDiv.className = 'mb-3';
                    userDiv.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <strong>üë§ You:</strong> ${escapeHtml(data.user_message)}
                    <br>
                    <small class="text-muted">Just now</small>
                </div>
            `;
                    chatbox.appendChild(userDiv);

                    // Add AI response
                    const aiDiv = document.createElement('div');
                    aiDiv.className = 'mb-3';
                    aiDiv.innerHTML = `
                <div class="alert alert-success" role="alert">
                    <strong><i class="fas fa-lightbulb"></i> Farm Advisor:</strong>
                    <p class="mb-0" style="margin-top: 10px; white-space: pre-wrap;">${escapeHtml(data.ai_response)}</p>
                </div>
            `;
                    chatbox.appendChild(aiDiv);

                    // Clear input
                    messageInput.value = '';
                    messageInput.focus();

                    // Scroll to bottom
                    scrollToBottom();
                } else {
                    alert(`Error: ${data.error || 'Failed to send message'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Message';
            }
        });

        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>

</html>